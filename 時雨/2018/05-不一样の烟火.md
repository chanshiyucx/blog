# ä¸ä¸€æ ·ã®çƒŸç«

[anime.js](http://animejs.com/) æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ JavaScript åŠ¨ç”»åº“ï¼ŒHeartBeat ä¸»é¢˜çš„èƒŒæ™¯ç‚¹å‡»ç‰¹æ•ˆå°±æ˜¯å€Ÿç”¨å…¶å®˜ç½‘å±•ç¤ºæ•ˆæœã€‚ä¸ºäº†å­¦ä¹ åŠ¨ç”»åº“çš„ä½¿ç”¨ï¼Œè¿™é‡Œç”¨ ES6 é‡æ„äº†çƒŸç«ä»£ç ï¼Œæ¥ä¸€åœºä¸ä¸€æ ·çš„çƒŸç«ã€‚

> Anime is a lightweight JavaScript animation library. It works with any CSS Properties, individual CSS transforms, SVG or any DOM attributes, and JavaScript Objects.

## ä¸ä¸€æ ·ã®çƒŸç«

åœ¨å¼€å§‹ä¹‹å‰ï¼Œå…ˆé“¾ä¸Š [Source Code](https://github.com/chanshiyucx/treasure/tree/master/firework) å’Œ [åœ¨çº¿é¢„è§ˆ](https://chanshiyu.com/treasure/firework/)ã€‚

### å¼•å…¥ anime.min.js

é¦–å…ˆåœ¨å¼•å…¥ `anime.min.js`ï¼Œè¿™é‡Œä½¿ç”¨ BootCDN å¤–é“¾ã€‚ç„¶ååˆ›å»ºä¸€ä¸ª canvas ç”»å¸ƒï¼Œç”¨æ¥å‘ˆç°çƒŸç«æ•ˆæœã€‚åœ¨ body æ ‡ç­¾å°¾éƒ¨å¼•å…¥ `index.js`ï¼Œæ¥ä¸‹æ¥å°±æ˜¯åœ¨ index.js å®Œæˆæœ€ç»ˆçš„çƒŸç«ä»£ç ã€‚

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>ä¸ä¸€æ ·ã®çƒŸç«</title>
    <script src="https://cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
  </head>
  <style>
    body {
      background: #000;
      overflow: hidden;
    }
  </style>
  <body>
    <canvas class="fireworks"></canvas>
    <script src="./index.js"></script>
  </body>
</html>
```

### åˆå§‹åŒ–ç”»å¸ƒ

åœ¨ index.js ä¸­ï¼Œæ–°å»ºä¸€ä¸ª Firework ç±»ï¼Œå¹¶åˆå§‹åŒ–ç”»å¸ƒå¤§å°å°ºå¯¸ã€‚

```javascript
class Firework {
  constructor() {
    this.canvasEl = null // ç”»å¸ƒå…ƒç´ 
    this.ctx = null // ç”»å¸ƒä¸Šä¸‹æ–‡
  }

  // Let's go
  start() {
    // åˆå§‹åŒ–ç”»å¸ƒ
    this.setCanvasSize()
  }

  // è®¾ç½®ç”»å¸ƒå°ºå¯¸
  setCanvasSize() {
    // è·å–ç”»å¸ƒå…ƒç´ 
    const canvasEl = document.querySelector('.fireworks')
    const ctx = canvasEl.getContext('2d')
    // çª—å£å°ºå¯¸
    const innerWidth = window.innerWidth
    const innerHeight = window.innerHeight
    // è®¾ç½®ç”»å¸ƒå°ºå¯¸
    canvasEl.width = innerWidth * 2
    canvasEl.height = innerHeight * 2
    canvasEl.style.width = innerWidth + 'px'
    canvasEl.style.height = innerHeight + 'px'
    ctx.scale(2, 2)
    // ä¿å­˜ç”»å¸ƒ
    this.canvasEl = canvasEl
    this.ctx = ctx
  }
}

const margicAnime = new Firework()
margicAnime.start()
```

### ç»‘å®šäº‹ä»¶

æ¥ä¸‹æ¥ç›‘å¬ç‚¹å‡»äº‹ä»¶ä»¥ç»˜åˆ¶åŠ¨ç”»ï¼Œå¹¶ä¸”ç›‘å¬çª—å£ç¼©æ”¾äº‹ä»¶ï¼Œå½“çª—å£å¤§å°å˜åŒ–æ—¶é‡ç½®ç”»å¸ƒå°ºå¯¸ã€‚ä¸ºäº†å…¼å®¹ä¸åŒæµè§ˆå™¨ï¼Œè¿™é‡Œå°†äº‹ä»¶ç»‘å®šå’Œè§£ç»‘æ–¹æ³•æå–å‡ºå…¬ç”¨æ–¹æ³•ã€‚

```javascript
/**
 * @description ç»‘å®šäº‹ä»¶ on(element, event, handler)
 */
const on = (function() {
  if (document.addEventListener) {
    return function(element, event, handler) {
      if (element && event && handler) {
        element.addEventListener(event, handler, false)
      }
    }
  } else {
    return function(element, event, handler) {
      if (element && event && handler) {
        element.attachEvent('on' + event, handler)
      }
    }
  }
})()

/**
 * @description è§£ç»‘äº‹ä»¶ off(element, event, handler)
 */
const off = (function() {
  if (document.removeEventListener) {
    return function(element, event, handler) {
      if (element && event) {
        element.removeEventListener(event, handler, false)
      }
    }
  } else {
    return function(element, event, handler) {
      if (element && event) {
        element.detachEvent('on' + event, handler)
      }
    }
  }
})()
```

ç„¶åæ·»åŠ ç»‘å®šäº‹ä»¶ï¼Œå¹¶ä¸”æ·»åŠ é”€æ¯æ–¹æ³•ï¼Œåœ¨é”€æ¯æ™‚è§£ç»‘äº‹ä»¶ï¼š

```javascript
// ç‚¹å‡»äº‹ä»¶
const tap = 'ontouchstart' in window || navigator.msMaxTouchPoints ? 'touchstart' : 'mousedown'

class Firework {
  // Let's go
  start() {
    // åˆå§‹åŒ–ç”»å¸ƒ
    this.setCanvasSize()

    // ç›‘å¬ç‚¹å‡»å’Œçª—å£ç¼©æ”¾äº‹ä»¶
    on(document, tap, this.render.bind(this))
    on(window, 'resize', this.setCanvasSize.bind(this))
  }

  // é”€æ¯
  destroyed() {
    off(document, tap, this.render.bind(this))
    off(window, 'resize', this.setCanvasSize.bind(this))
    this.tapFunc = this.resizeFunc = this.renderAnime = null
  }

  // ç‚¹å‡»äº‹ä»¶
  render() {}
}
```

### æ“¦é™¤ä¸ç»˜åˆ¶

å€ŸåŠ© anime.jsï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ¨æ¯ä¸€å¸§ç”»å¸ƒæ›´æ–°åæ“¦é™¤ç”»å¸ƒï¼Œé€šè¿‡ä¸æ–­æ¸…é™¤ç”»å¸ƒå†…å®¹å†ç»˜åˆ¶ï¼Œå½¢æˆåŠ¨ç”»æ•ˆæœã€‚

```javascript
class Firework {
  // ç‚¹å‡»äº‹ä»¶
  render(e) {
    const canvasEl = this.canvasEl
    const ctx = this.ctx

    // ç»˜åˆ¶å‰å¯ç”¨æ“¦é™¤åŠ¨ç”»
    if (!this.renderAnime) {
      this.renderAnime = anime({
        duration: Infinity,
        update() {
          // æ“¦é™¤ç”»å¸ƒ
          ctx.clearRect(0, 0, canvasEl.width, canvasEl.height)
        }
      })
    }
    this.renderAnime.play()

    // ç‚¹å‡»åæ ‡
    const pointerX = e.clientX || e.touches[0].clientX
    const pointerY = e.clientY || e.touches[0].clientY
    this.animateParticules(pointerX, pointerY)
  }

  // ç»˜åˆ¶çƒŸç«
  animateParticules() {}
}
```

### ç»˜åˆ¶çƒŸç«

ç»˜åˆ¶çƒŸç«æ˜¯æœ€ä¸ºæ ¸å¿ƒä»£ç ï¼ŒçƒŸç«ç”±æ‰©æ•£åœˆçš„çƒŸç«ç²’å­ä¸¤éƒ¨åˆ†ç»„æˆã€‚å¹¶åœ¨æ¯ä¸€ä¸ªåŠ¨ç”»å¸§æ›´æ–°åé‡æ–°ç»˜åˆ¶ç²’å­ã€‚

```javascript
class Firework {
  constructor() {
    this.numberOfParticules = 30 // ç²’å­æ•°é‡
    this.colors = ['#FF1461', '#18FF92', '#5A87FF', '#FBF38C'] // ç²’å­é¢œè‰²
  }

  // åˆ›å»ºæ‰©æ•£åœˆ
  createCircle(x, y) {
    const ctx = this.ctx
    const p = {}
    p.x = x
    p.y = y
    p.color = '#FFF'
    p.radius = 0.1
    p.alpha = 0.5
    p.lineWidth = 6
    p.draw = function() {
      ctx.globalAlpha = p.alpha
      ctx.beginPath()
      // ç»˜åˆ¶æ­£åœ†
      ctx.arc(p.x, p.y, p.radius, 0, 2 * Math.PI, true)
      ctx.lineWidth = p.lineWidth
      ctx.strokeStyle = p.color
      ctx.stroke()
      ctx.globalAlpha = 1
    }
    return p
  }

  // åˆ›å»ºç²’å­
  createParticule(x, y) {
    const ctx = this.ctx
    const p = {}
    p.x = x
    p.y = y
    p.color = this.colors[anime.random(0, this.colors.length - 1)]
    p.radius = anime.random(16, 32)
    p.endPos = this.setParticuleDirection(p)
    p.draw = function() {
      ctx.beginPath()
      ctx.arc(p.x, p.y, p.radius, 0, 2 * Math.PI, true)
      ctx.fillStyle = p.color
      ctx.fill()
    }
    return p
  }

  // ç²’å­æ‰©æ•£æ–¹å‘
  setParticuleDirection(p) {
    const angle = (anime.random(0, 360) * Math.PI) / 180
    const value = anime.random(50, 180)
    const radius = [-1, 1][anime.random(0, 1)] * value
    return {
      x: p.x + radius * Math.cos(angle),
      y: p.y + radius * Math.sin(angle)
    }
  }

  // ç»˜åˆ¶ç²’å­
  renderParticule(anim) {
    for (let i = 0; i < anim.animatables.length; i++) {
      anim.animatables[i].target.draw()
    }
  }

  // ç»˜åˆ¶çƒŸç«
  animateParticules(x, y) {
    const circle = this.createCircle(x, y)
    const particules = []
    for (let i = 0; i < this.numberOfParticules; i++) {
      particules.push(this.createParticule(x, y))
    }
    const renderParticule = this.renderParticule
    anime
      .timeline()
      .add({
        targets: particules,
        x(p) {
          return p.endPos.x
        },
        y(p) {
          return p.endPos.y
        },
        radius: 0.1,
        duration: anime.random(1200, 1800),
        easing: 'easeOutExpo',
        // æ¯ä¸€ä¸ªåŠ¨ç”»å¸§æ›´æ–°åé‡æ–°ç»˜åˆ¶ç²’å­
        update: renderParticule
      })
      .add({
        targets: circle,
        radius: anime.random(80, 160),
        lineWidth: 0,
        alpha: {
          value: 0,
          easing: 'linear',
          duration: anime.random(600, 800)
        },
        duration: anime.random(1200, 1800),
        easing: 'easeOutExpo',
        update: renderParticule,
        offset: 0
      })
  }
}
```

## å¤§åŠŸå‘Šæˆ

æœ€ç»ˆçƒŸç«æ•ˆæœä»£ç å¦‚ä¸‹ï¼š

```javascript
/**
 * @description ç»‘å®šäº‹ä»¶ on(element, event, handler)
 */
const on = (function() {
  if (document.addEventListener) {
    return function(element, event, handler) {
      if (element && event && handler) {
        element.addEventListener(event, handler, false)
      }
    }
  } else {
    return function(element, event, handler) {
      if (element && event && handler) {
        element.attachEvent('on' + event, handler)
      }
    }
  }
})()

/**
 * @description è§£ç»‘äº‹ä»¶ off(element, event, handler)
 */
const off = (function() {
  if (document.removeEventListener) {
    return function(element, event, handler) {
      if (element && event) {
        element.removeEventListener(event, handler, false)
      }
    }
  } else {
    return function(element, event, handler) {
      if (element && event) {
        element.detachEvent('on' + event, handler)
      }
    }
  }
})()

// ç‚¹å‡»äº‹ä»¶
const tap = 'ontouchstart' in window || navigator.msMaxTouchPoints ? 'touchstart' : 'mousedown'

class Firework {
  constructor() {
    this.canvasEl = null // ç”»å¸ƒå…ƒç´ 
    this.ctx = null // ç”»å¸ƒä¸Šä¸‹æ–‡
    this.numberOfParticules = 30 // ç²’å­æ•°é‡
    this.colors = ['#FF1461', '#18FF92', '#5A87FF', '#FBF38C'] // ç²’å­é¢œè‰²
    this.tapFunc = null
    this.resizeFunc = null
    this.renderAnime = null
  }

  // Let's go
  start() {
    // åˆå§‹åŒ–ç”»å¸ƒ
    this.setCanvasSize()

    // ç›‘å¬ç‚¹å‡»å’Œçª—å£ç¼©æ”¾äº‹ä»¶
    on(document, tap, this.render.bind(this))
    on(window, 'resize', this.setCanvasSize.bind(this))
  }

  // é”€æ¯
  destroyed() {
    off(document, tap, this.render.bind(this))
    off(window, 'resize', this.setCanvasSize.bind(this))
    this.tapFunc = this.resizeFunc = this.renderAnime = null
  }

  // è®¾ç½®ç”»å¸ƒå°ºå¯¸
  setCanvasSize() {
    // è·å–ç”»å¸ƒå…ƒç´ 
    const canvasEl = document.querySelector('.fireworks')
    const ctx = canvasEl.getContext('2d')
    // çª—å£å°ºå¯¸
    const innerWidth = window.innerWidth
    const innerHeight = window.innerHeight
    // è®¾ç½®ç”»å¸ƒå°ºå¯¸
    canvasEl.width = innerWidth * 2
    canvasEl.height = innerHeight * 2
    canvasEl.style.width = innerWidth + 'px'
    canvasEl.style.height = innerHeight + 'px'
    ctx.scale(2, 2)
    // ä¿å­˜ç”»å¸ƒ
    this.canvasEl = canvasEl
    this.ctx = ctx
  }

  // åˆ›å»ºç‚¹å‡»æ‰©æ•£åœˆ
  createCircle(x, y) {
    const ctx = this.ctx
    const p = {}
    p.x = x
    p.y = y
    p.color = '#FFF'
    p.radius = 0.1
    p.alpha = 0.5
    p.lineWidth = 6
    p.draw = function() {
      ctx.globalAlpha = p.alpha
      ctx.beginPath()
      ctx.arc(p.x, p.y, p.radius, 0, 2 * Math.PI, true)
      ctx.lineWidth = p.lineWidth
      ctx.strokeStyle = p.color
      ctx.stroke()
      ctx.globalAlpha = 1
    }
    return p
  }

  // åˆ›å»ºç‚¹å‡»ç²’å­
  createParticule(x, y) {
    const ctx = this.ctx
    const p = {}
    p.x = x
    p.y = y
    p.color = this.colors[anime.random(0, this.colors.length - 1)]
    p.radius = anime.random(16, 32)
    p.endPos = this.setParticuleDirection(p)
    p.draw = function() {
      ctx.beginPath()
      ctx.arc(p.x, p.y, p.radius, 0, 2 * Math.PI, true)
      ctx.fillStyle = p.color
      ctx.fill()
    }
    return p
  }

  // ç²’å­æ‰©æ•£æ–¹å‘
  setParticuleDirection(p) {
    const angle = (anime.random(0, 360) * Math.PI) / 180
    const value = anime.random(50, 180)
    const radius = [-1, 1][anime.random(0, 1)] * value
    return {
      x: p.x + radius * Math.cos(angle),
      y: p.y + radius * Math.sin(angle)
    }
  }

  // ç»˜åˆ¶ç²’å­
  renderParticule(anim) {
    for (let i = 0; i < anim.animatables.length; i++) {
      anim.animatables[i].target.draw()
    }
  }

  // ç»˜åˆ¶çƒŸç«
  animateParticules(x, y) {
    const circle = this.createCircle(x, y)
    const particules = []
    for (let i = 0; i < this.numberOfParticules; i++) {
      particules.push(this.createParticule(x, y))
    }
    const renderParticule = this.renderParticule
    anime
      .timeline()
      .add({
        targets: particules,
        x(p) {
          return p.endPos.x
        },
        y(p) {
          return p.endPos.y
        },
        radius: 0.1,
        duration: anime.random(1200, 1800),
        easing: 'easeOutExpo',
        update: renderParticule
      })
      .add({
        targets: circle,
        radius: anime.random(80, 160),
        lineWidth: 0,
        alpha: {
          value: 0,
          easing: 'linear',
          duration: anime.random(600, 800)
        },
        duration: anime.random(1200, 1800),
        easing: 'easeOutExpo',
        update: renderParticule,
        offset: 0
      })
  }

  // ç‚¹å‡»äº‹ä»¶
  render(e) {
    const canvasEl = this.canvasEl
    const ctx = this.ctx

    // ç»˜åˆ¶å‰å¯ç”¨æ“¦é™¤ç”»å¸ƒ
    if (!this.renderAnime) {
      this.renderAnime = anime({
        duration: Infinity,
        update() {
          ctx.clearRect(0, 0, canvasEl.width, canvasEl.height)
        }
      })
    }
    this.renderAnime.play()

    // ç‚¹å‡»åæ ‡
    const pointerX = e.clientX || e.touches[0].clientX
    const pointerY = e.clientY || e.touches[0].clientY
    this.animateParticules(pointerX, pointerY)
  }
}

const margicAnime = new Firework()
margicAnime.start()
```

Just enjoy it ğŸ˜ƒ!
